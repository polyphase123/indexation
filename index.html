<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GEAR5 Green Energy Auction Reserve Price Indexation Simulator">
    <title>GEAR5 Indexation Simulator</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- PropTypes (Required for Recharts UMD) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script crossorigin src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* Compact Table Styling for Laptop View */
        .compact-table th, .compact-table td {
            padding: 6px 4px;
            font-size: 11px;
            text-align: center;
        }
        .compact-table th:first-child, .compact-table td:first-child {
            text-align: left;
            padding-left: 12px;
        }
        @media (min-width: 1024px) {
            .compact-table th, .compact-table td {
                font-size: 11px; 
            }
        }
        
        /* Table Container Tweaks */
        .table-container {
            border-radius: 0 0 12px 12px;
        }
        
        /* Custom Scrollbar for panels */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- 1. SETUP & UTILITIES ---
        const { useState, useMemo, useEffect } = React;

        // --- 2. ICONS ---
        const Icons = {
            Calculator: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
            ),
            TrendingUp: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
            ),
            DollarSign: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="1" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            ),
            Scale: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
            ),
            AlertCircle: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
            ),
            Settings: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12.22 2-.44.25a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            ),
            RefreshCcw: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
            ),
            Grid: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            ),
            Book: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
            ),
            Globe: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            ),
            Calendar: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            ),
            Clock: ({ size = 20, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            )
        };

        // --- 3. CONSTANTS & DATA ---
        const CONSTANTS = {
            DEFAULT_BID: 10.0000,
            DEFAULT_BASE_FX: 58.5000, // Changed from BASE_FX to default
            LOCAL_COMPONENT: 0.30,
            FOREX_COMPONENT: 0.70,
            PRELIMINARY_GEAR_PRICE: 10.3859,
            D0_DATE_STR: "2025-11-25", // D0 is Nov 25, 2025
            COA_LAG_DAYS: 543,
            COA_WORKING_DAYS_BUFFER: 30
        };

        const KEY_RATES = [
            { val: 54.00, label: "Scenario 3", source: "Scenario 3", type: "scenario" },
            { val: 56.00, label: "DBCC Low", source: "NEDA", type: "neda" },
            { val: 56.50, label: "Hist. '24", source: "Bloomberg", type: "bloomberg" },
            { val: 57.00, label: "DBCC Mid", source: "NEDA", type: "neda" },
            { val: 57.45, label: "BSP Avg", source: "BSP Fwd", type: "bsp" },
            { val: 57.80, label: "25 F'cast", source: "Bloomberg", type: "bloomberg" },
            { val: 58.00, label: "DBCC High", source: "NEDA", type: "neda" },
            { val: 58.50, label: "Base Rate", source: "Official", type: "base" },
            { val: 59.80, label: "31 F'cast", source: "Bloomberg", type: "bloomberg" },
            { val: 61.20, label: "32 F'cast", source: "Bloomberg", type: "bloomberg" },
            { val: 62.00, label: "Scenario 2", source: "Scenario 2", type: "scenario" }
        ];

        // --- 4. UTILITY FUNCTIONS ---
        
        // Helper to add working days
        const addWorkingDays = (startDate, days) => {
            let currentDate = new Date(startDate);
            let added = 0;
            while (added < days) {
                currentDate.setDate(currentDate.getDate() + 1);
                const day = currentDate.getDay();
                if (day !== 0 && day !== 6) { // Skip Sunday (0) and Saturday (6)
                    added++;
                }
            }
            return currentDate;
        };

        const calculateCOADate = () => {
            const d0 = new Date(CONSTANTS.D0_DATE_STR);
            const d1 = new Date(d0);
            d1.setDate(d0.getDate() + 1); // D1 is D0 + 1 day
            
            // Add 543 calendar days to D1
            const d1_plus_543 = new Date(d1);
            d1_plus_543.setDate(d1.getDate() + CONSTANTS.COA_LAG_DAYS);
            
            // Add 30 working days
            const finalCOA = addWorkingDays(d1_plus_543, CONSTANTS.COA_WORKING_DAYS_BUFFER);
            return { d1, finalCOA };
        };

        const formatDate = (date) => {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        // --- 5. SUB-COMPONENTS ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}>
                {children}
            </div>
        );

        const MetricBox = ({ label, value, subtext, icon: Icon, trend }) => (
            <div className="bg-slate-50 p-4 rounded-lg border border-slate-100 flex items-start space-x-3 transition-all hover:shadow-md h-full">
                <div className={`p-2 rounded-lg ${trend === 'up' ? 'bg-emerald-100 text-emerald-600' : trend === 'neutral' ? 'bg-blue-100 text-blue-600' : 'bg-amber-100 text-amber-600'}`}>
                    {Icon && <Icon size={20} />}
                </div>
                <div>
                    <p className="text-xs font-medium text-slate-500 uppercase tracking-wide">{label}</p>
                    <p className="text-2xl font-bold text-slate-900 mt-1">{value}</p>
                    {subtext && <p className="text-xs text-slate-400 mt-1">{subtext}</p>}
                </div>
            </div>
        );

        const SliderControl = ({ label, value, onChange, min, max, step, unit, note, disabled=false }) => (
            <div className={`space-y-3 ${disabled ? 'opacity-50 pointer-events-none' : ''}`}>
                <div className="flex justify-between items-center">
                    <label className="text-sm font-medium text-slate-700">{label}</label>
                    <span className="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                        {typeof value === 'number' ? value.toFixed(step < 1 ? 2 : 2) : value} {unit}
                    </span>
                </div>
                <input
                    type="range"
                    min={min}
                    max={max}
                    step={step}
                    value={value}
                    onChange={(e) => onChange(parseFloat(e.target.value))}
                    className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600 hover:accent-blue-700 transition-all"
                />
                {note && <p className="text-xs text-slate-400 italic">{note}</p>}
            </div>
        );

        const TimelineControl = ({ year, setYear, scenario, setScenario, codDelay, setCodDelay, computedDelay }) => {
            const years = [2028, 2029, 2030];
            const { d1, finalCOA: coaDate } = calculateCOADate();
            const coaStr = formatDate(coaDate);
            const d0Str = formatDate(new Date(CONSTANTS.D0_DATE_STR));
            const d1Str = formatDate(d1);

            return (
                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                    <div className="flex items-center gap-2 mb-2 pb-2 border-b border-slate-200">
                        <Icons.Calendar size={18} className="text-slate-600" />
                        <h4 className="font-bold text-sm text-slate-800">SECTION 1.6: TIMELINE</h4>
                    </div>

                    {/* Assumptions Display */}
                    <div className="text-[10px] text-slate-500 space-y-1 mb-2 bg-white p-2 rounded border border-slate-100">
                        <div className="flex justify-between">
                            <span>D0 (Start):</span>
                            <span className="font-mono font-bold">{d0Str}</span>
                        </div>
                        <div className="flex justify-between text-slate-400">
                            <span>D1 (D0+1):</span>
                            <span className="font-mono">{d1Str}</span>
                        </div>
                        <div className="flex justify-between pt-1 border-t border-slate-100 mt-1">
                            <span>Est. COA Date:</span>
                            <span className="font-mono font-bold text-blue-600">{coaStr}</span>
                        </div>
                        <div className="text-[9px] italic text-slate-400 text-right mt-1">
                            Formula: D1 + {CONSTANTS.COA_LAG_DAYS} days + {CONSTANTS.COA_WORKING_DAYS_BUFFER} WD
                        </div>
                    </div>

                    {/* Year Selection */}
                    <div>
                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Target DCD Year</label>
                        <div className="grid grid-cols-3 gap-2">
                            {years.map(y => (
                                <button
                                    key={y}
                                    onClick={() => setYear(y)}
                                    className={`py-2 px-1 text-sm font-bold rounded-lg border transition-all ${year === y ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-100'}`}
                                >
                                    {y}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Scenario Selection */}
                    <div>
                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Delay Scenario</label>
                        <select 
                            value={scenario} 
                            onChange={(e) => setScenario(e.target.value)}
                            className="w-full p-2 text-sm bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-slate-700"
                        >
                            <option value="standard">Standard / Bidder Default (Cap at DCD)</option>
                            <option value="force_majeure">Force Majeure / Infra Limit (Cap at COD)</option>
                        </select>
                    </div>

                    {/* Force Majeure Extension */}
                    {scenario === 'force_majeure' && (
                        <div className="bg-amber-50 p-3 rounded-lg border border-amber-100 animate-in fade-in slide-in-from-top-2 duration-300">
                            <SliderControl 
                                label="Extension to COD" 
                                value={codDelay} 
                                min={0} max={24} step={1} 
                                unit="Mos" 
                                onChange={setCodDelay}
                            />
                        </div>
                    )}

                    {/* Result Display */}
                    <div className="flex justify-between items-center pt-2 border-t border-slate-200 mt-2">
                        <span className="text-sm text-slate-500">Adjustment Period:</span>
                        <span className="text-lg font-bold text-slate-900">{computedDelay} Months</span>
                    </div>
                    
                    <div className="bg-blue-50 p-2 rounded text-[10px] text-blue-700 italic leading-tight">
                        Period between COA ({coaStr}) and {scenario === 'force_majeure' ? 'COD' : 'DCD'} ({year}).
                    </div>
                </div>
            );
        };

        // --- 6. REFERENCE & DEFINITIONS ---
        
        const ReferenceSection = ({ baseFx }) => (
            <div className="mt-8">
                <Card className="p-6">
                    <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4">
                        <Icons.Book size={18} className="text-blue-600" />
                        Data Sources & Definitions
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-xs">
                        <div className="p-3 bg-emerald-50 border border-emerald-100 rounded-lg">
                            <h4 className="font-bold text-emerald-800 mb-1 flex items-center gap-1">
                                <Icons.Globe size={12}/> DBCC / NEDA
                            </h4>
                            <p className="text-emerald-700 mb-2">Development Budget Coordination Committee under NEDA. Sets official macroeconomic assumptions for the Philippine budget.</p>
                            <a href="https://www.neda.gov.ph" target="_blank" className="text-blue-600 hover:underline">neda.gov.ph</a>
                        </div>
                        <div className="p-3 bg-indigo-50 border border-indigo-100 rounded-lg">
                            <h4 className="font-bold text-indigo-800 mb-1 flex items-center gap-1">
                                <Icons.Globe size={12}/> BSP
                            </h4>
                            <p className="text-indigo-700 mb-2">Bangko Sentral ng Pilipinas. Central bank providing forward exchange rate estimates used in the GEAR5 document.</p>
                            <a href="https://www.bsp.gov.ph" target="_blank" className="text-blue-600 hover:underline">bsp.gov.ph</a>
                        </div>
                        <div className="p-3 bg-fuchsia-50 border border-fuchsia-100 rounded-lg">
                            <h4 className="font-bold text-fuchsia-800 mb-1 flex items-center gap-1">
                                <Icons.Globe size={12}/> Bloomberg
                            </h4>
                            <p className="text-fuchsia-700 mb-2">Global financial data provider. Reference for market consensus forecasts and historical averages (e.g., 2024 avg ~56.50).</p>
                            <a href="https://www.bloomberg.com/markets/currencies" target="_blank" className="text-blue-600 hover:underline">bloomberg.com</a>
                        </div>
                        <div className="p-3 bg-slate-50 border border-slate-200 rounded-lg">
                            <h4 className="font-bold text-slate-800 mb-1">Scenario Notes</h4>
                            <p className="text-slate-600">
                                <strong>D0:</strong> Nov 25, 2025. <strong>D1:</strong> Nov 26, 2025.<br/>
                                <strong>COA Date:</strong> D1 + 543 Days + 30 Working Days.<br/>
                                <strong>Base FX Used:</strong> {baseFx.toFixed(2)} PHP/USD.<br/>
                                <strong>Adjustment:</strong> One-time adjustment based on period from COA to DCD/COD.
                            </p>
                        </div>
                    </div>
                </Card>
            </div>
        );

        // --- 7. HEAT MAP COMPONENTS ---

        const HeatMapBase = ({ title, columns, bidRows, getCellData, legend }) => (
            <div className="mt-8 overflow-hidden rounded-xl border border-slate-200 shadow-sm bg-white">
                <div className="bg-slate-50 p-4 border-b border-slate-200">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-2">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2">
                            <Icons.Grid size={18} className="text-blue-600" />
                            {title}
                        </h3>
                        {legend}
                    </div>
                </div>
                
                {/* No horizontal scroll - compact layout */}
                <div className="w-full table-container">
                    <table className="w-full text-right border-collapse compact-table">
                        <thead>
                            <tr>
                                <th className="bg-slate-100 font-semibold text-slate-600 border-b border-slate-200 w-24">
                                    Bid (₱)
                                </th>
                                {columns.map((col, idx) => (
                                    <th key={idx} className={`border-b border-slate-200 ${col.headerClass || 'bg-slate-50 text-slate-500 font-medium'}`}>
                                        <div className="flex flex-col items-center justify-center">
                                            <span>{col.label}</span>
                                            {col.subLabel && <span className="text-[8px] opacity-75 whitespace-nowrap leading-none mt-0.5">{col.subLabel}</span>}
                                        </div>
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {bidRows.map((bid) => (
                                <tr key={bid} className="hover:bg-slate-50 group">
                                    <td className={`font-bold text-slate-700 border-b border-slate-100 group-hover:bg-slate-50 ${bid === CONSTANTS.PRELIMINARY_GEAR_PRICE ? 'bg-emerald-50 text-emerald-800' : 'bg-white'}`}>
                                        {bid.toFixed(4)}
                                    </td>
                                    {columns.map((col, idx) => {
                                        const { value, bgClass, textClass } = getCellData(bid, col.val);
                                        return (
                                            <td key={idx} className={`border-b border-slate-100 ${bgClass} ${textClass}`}>
                                                {value}
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        const ForexHeatMap = ({ calculateTariff, baseFx }) => {
            const bidRows = [8.00, 8.50, 9.00, 9.50, 10.00, CONSTANTS.PRELIMINARY_GEAR_PRICE];

            const columns = useMemo(() => {
                const cols = new Set();
                // Add Integers 54 to 63
                for (let fx = 54.00; fx <= 63.00; fx += 1.00) cols.add(fx);
                // Add Key Rates
                KEY_RATES.forEach(r => cols.add(r.val));
                
                return Array.from(cols).sort((a, b) => a - b).map(fx => {
                    const special = KEY_RATES.find(r => Math.abs(r.val - fx) < 0.001);
                    let headerClass = "bg-slate-50 text-slate-500 font-medium";
                    let label = fx.toFixed(special ? 2 : 0); // Remove decimals for integers to save space if not special
                    if(special) label = fx.toFixed(2);

                    if (special) {
                        switch(special.type) {
                            case 'base': headerClass = "bg-yellow-50 text-yellow-700 font-bold border-yellow-200 border-b-2"; break;
                            case 'bloomberg': headerClass = "bg-fuchsia-50 text-fuchsia-700 font-bold border-fuchsia-200 border-b-2"; break;
                            case 'neda': headerClass = "bg-emerald-50 text-emerald-700 font-bold border-emerald-200 border-b-2"; break;
                            case 'bsp': headerClass = "bg-indigo-50 text-indigo-700 font-bold border-indigo-200 border-b-2"; break;
                            default: headerClass = "bg-slate-100 text-slate-600 font-semibold";
                        }
                    }
                    return { val: fx, label, subLabel: special?.label, headerClass, type: special?.type };
                });
            }, []);

            const getCellData = (bid, fx) => {
                const { tariff, isFloor } = calculateTariff(bid, fx);
                let bgClass = "bg-white", textClass = "text-slate-600";
                
                if (isFloor) {
                    bgClass = "bg-slate-50 text-slate-400";
                } else {
                    const increase = tariff - bid;
                    // Max increase calc assumes upper bound of sensitivity ~63 vs base
                    const maxIncrease = (bid * (0.3 + 0.7 * (63/baseFx))) - bid;
                    const intensity = Math.min((increase / maxIncrease), 1);
                    if (intensity < 0.2) bgClass = "bg-blue-50 text-blue-700";
                    else if (intensity < 0.4) bgClass = "bg-blue-100 text-blue-800";
                    else if (intensity < 0.6) bgClass = "bg-blue-200 text-blue-900";
                    else if (intensity < 0.8) bgClass = "bg-blue-300 text-blue-900";
                    else bgClass = "bg-blue-400 text-white font-bold";
                    if(bgClass.includes('text-white')) textClass = "text-white";
                }

                const colData = columns.find(c => c.val === fx);
                if (colData?.type === 'base') { bgClass = "bg-yellow-50 border-x border-yellow-200"; textClass = "text-yellow-900 font-bold"; }
                else if (colData?.type === 'bloomberg') bgClass = "bg-fuchsia-50 border-x border-fuchsia-100";
                else if (colData?.type === 'neda') bgClass = "bg-emerald-50 border-x border-emerald-100";
                else if (colData?.type === 'bsp') bgClass = "bg-indigo-50 border-x border-indigo-100";

                return { value: tariff.toFixed(3), bgClass, textClass };
            };

            const legend = (
                <div className="flex flex-wrap gap-3 text-xs font-medium">
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> Base</span>
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-fuchsia-400"></span> Bloomberg</span>
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-emerald-400"></span> NEDA</span>
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-indigo-400"></span> BSP</span>
                </div>
            );

            return <HeatMapBase title="FX Sensitivity Matrix (PHP/kWh)" columns={columns} bidRows={bidRows} getCellData={getCellData} legend={legend} />;
        };

        const InflationHeatMap = ({ calculateTariff, inflationRate }) => {
            const bidRows = [8.00, 8.50, 9.00, 9.50, 10.00, CONSTANTS.PRELIMINARY_GEAR_PRICE];
            
            const columns = [6, 12, 18, 24, 30, 36, 42, 48, 54, 60].map(m => ({
                val: m,
                label: `${m} Mo`,
                headerClass: "bg-slate-50 text-slate-600 font-medium"
            }));

            const getCellData = (bid, months) => {
                const tariff = calculateTariff(bid, inflationRate, months);
                let bgClass = "bg-white", textClass = "text-slate-600";

                const maxTariff = calculateTariff(bid, inflationRate, 60);
                const intensity = (tariff - bid) / (maxTariff - bid);

                if (intensity < 0.2) bgClass = "bg-purple-50 text-purple-700";
                else if (intensity < 0.4) bgClass = "bg-purple-100 text-purple-800";
                else if (intensity < 0.6) bgClass = "bg-purple-200 text-purple-900";
                else if (intensity < 0.8) bgClass = "bg-purple-300 text-purple-900";
                else { bgClass = "bg-purple-600 text-white font-bold"; textClass = "text-white"; }

                return { value: tariff.toFixed(3), bgClass, textClass };
            };

            const legend = (
                <div className="flex items-center gap-2 text-xs text-slate-500">
                    <span>Assuming constant annual inflation of <strong className="text-purple-600">{inflationRate}%</strong></span>
                </div>
            );

            return <HeatMapBase title={`Inflation Delay Matrix (Bid vs Months)`} columns={columns} bidRows={bidRows} getCellData={getCellData} legend={legend} />;
        };

        // --- 8. COMPARISON PANEL ---
        
        const ComparisonPanel = ({ bidPrice, calculateForex, calculateInflation, delayMonths, baseFx }) => {
            const [scenarioFx, setScenarioFx] = useState(56.00); 
            const [scenarioInf, setScenarioInf] = useState(3.0);
            
            // Generate Intersection Data
            const chartData = useMemo(() => {
                const data = [];
                const forexVal = calculateForex(bidPrice, scenarioFx).tariff;
                
                // We show range around the calculated "delayMonths" but fixed for context
                for (let m = 0; m <= 60; m+=2) {
                    const inflationVal = calculateInflation(bidPrice, scenarioInf, m);
                    data.push({
                        month: m,
                        forexLine: forexVal,
                        inflationLine: inflationVal
                    });
                }
                return data;
            }, [bidPrice, scenarioFx, scenarioInf, baseFx]);

            // Calculate "Intersection" Month
            const breakEvenMonth = useMemo(() => {
                const forexVal = calculateForex(bidPrice, scenarioFx).tariff;
                if (scenarioInf === 0) return 999;
                const m = ((forexVal / bidPrice) - 1) * 1200 / scenarioInf;
                return m > 0 ? m : 0;
            }, [bidPrice, scenarioFx, scenarioInf, baseFx]);

            const Recharts = window.Recharts;
            const canRenderChart = Recharts && Recharts.LineChart && Recharts.Line && Recharts.XAxis && Recharts.YAxis && Recharts.CartesianGrid && Recharts.Tooltip && Recharts.ResponsiveContainer && Recharts.ReferenceLine && Recharts.Legend;

            if (!canRenderChart) {
                 return <div className="p-10 text-center text-slate-400 bg-slate-50 rounded-xl border border-slate-200">Loading Chart Components...</div>;
            }

            const { LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend: ChartLegend, ReferenceLine } = Recharts;

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                        {/* Scenario Controls */}
                        <div className="md:col-span-4 space-y-4">
                            <Card className="p-6 h-full space-y-6">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                    <Icons.Settings size={18} /> Scenario Builder
                                </h3>
                                <div className="space-y-6">
                                    <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                        <label className="text-xs font-bold text-blue-800 block mb-2 flex justify-between">
                                            <span>Forex Scenario</span>
                                            <span>{scenarioFx.toFixed(2)} PHP</span>
                                        </label>
                                        <input type="range" min={50} max={65} step={0.1} value={scenarioFx} onChange={(e) => setScenarioFx(parseFloat(e.target.value))} className="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                        <p className="text-[10px] text-blue-600 mt-2 leading-tight">
                                            {scenarioFx < baseFx 
                                                ? "Peso strengthens (Tariff hits floor)." 
                                                : "Peso weakens (Tariff increases)."}
                                        </p>
                                    </div>
                                    <div className="p-4 bg-purple-50 rounded-xl border border-purple-100">
                                        <label className="text-xs font-bold text-purple-800 block mb-2 flex justify-between">
                                            <span>Inflation Rate</span>
                                            <span>{scenarioInf.toFixed(1)}% / yr</span>
                                        </label>
                                        <input type="range" min={1} max={8} step={0.1} value={scenarioInf} onChange={(e) => setScenarioInf(parseFloat(e.target.value))} className="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer accent-purple-600" />
                                    </div>
                                </div>

                                <div className={`p-4 rounded-xl border-l-4 ${breakEvenMonth <= 6 ? 'bg-amber-50 border-amber-400 text-amber-900' : 'bg-emerald-50 border-emerald-500 text-emerald-900'}`}>
                                    <h4 className="font-bold text-sm mb-1">
                                        {breakEvenMonth <= 0 
                                            ? "Forex is IMMEDIATELY Cheaper" 
                                            : `Intersection at ~${breakEvenMonth.toFixed(1)} Months`}
                                    </h4>
                                    <p className="text-xs opacity-90">
                                        {breakEvenMonth <= 0 
                                            ? "Because the Floor Price protects the Forex tariff, any inflation instantly makes the Inflation Option more expensive."
                                            : `Inflation is cheaper for the first ${(breakEvenMonth/12).toFixed(1)} years. Forex becomes advantageous afterwards as it stays fixed.`}
                                    </p>
                                </div>
                            </Card>
                        </div>

                        {/* Intersection Chart */}
                        <div className="md:col-span-8">
                            <Card className="p-6 h-[450px] flex flex-col">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-slate-900">Tariff Intersection Analysis</h3>
                                    <span className="text-xs px-2 py-1 bg-slate-100 rounded text-slate-500">Duration: 5 Years</span>
                                </div>
                                <div className="flex-1 min-h-0">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={chartData} margin={{ top: 10, right: 30, left: 10, bottom: 30 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis 
                                                dataKey="month" 
                                                label={{ value: 'Delay Duration (Months)', position: 'insideBottom', offset: -5, style: { fill: '#64748b', fontSize: '12px' } }} 
                                                tick={{ fill: '#64748b', fontSize: '12px' }} 
                                            />
                                            <YAxis 
                                                domain={['auto', 'auto']} 
                                                tickFormatter={(val) => `₱${val.toFixed(2)}`} 
                                                tick={{ fill: '#64748b', fontSize: '12px' }} 
                                            />
                                            <Tooltip 
                                                contentStyle={{ borderRadius: '8px', border: '1px solid #e2e8f0', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                                                formatter={(val, name) => [`₱ ${val.toFixed(4)}`, name === 'forexLine' ? 'Forex Option' : 'Inflation Option']}
                                                labelFormatter={(label) => `Month ${label}`}
                                            />
                                            <ChartLegend verticalAlign="top" height={36}/>
                                            <ReferenceLine x={delayMonths} stroke="#64748b" strokeDasharray="3 3" label={{ value: 'Your Delay', angle: -90, position: 'insideTopRight' }} />
                                            
                                            <Line 
                                                type="step" 
                                                dataKey="forexLine" 
                                                name="Forex Option (70% component)" 
                                                stroke="#2563eb" 
                                                strokeWidth={3} 
                                                dot={false}
                                            />
                                            <Line 
                                                type="monotone" 
                                                dataKey="inflationLine" 
                                                name="Inflation Option (100% component)" 
                                                stroke="#9333ea" 
                                                strokeWidth={3} 
                                                dot={false} 
                                            />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 9. MAIN APPLICATION ---

        function IndexationSimulator() {
            const [activeTab, setActiveTab] = useState('forex'); 
            const [bidPrice, setBidPrice] = useState(CONSTANTS.DEFAULT_BID);
            const [fxRate, setFxRate] = useState(62.00);
            const [inflationRate, setInflationRate] = useState(3.0);
            
            // New State: Base FX Rate
            const [baseFx, setBaseFx] = useState(CONSTANTS.DEFAULT_BASE_FX);

            // New State for Timeline Logic
            const [targetYear, setTargetYear] = useState(2028);
            const [delayScenario, setDelayScenario] = useState('standard'); // 'standard' or 'force_majeure'
            const [codDelay, setCodDelay] = useState(0); // Extra delay in months for Force Majeure

            // Calculate Months Delay based on COA to DCD
            const calculatedMonthsDelay = useMemo(() => {
                const { finalCOA: coaDate } = calculateCOADate();
                
                // Determine DCD Date (Assumed Jan 1 of Target Year as per typical logic, or adjust if needed)
                const dcdDate = new Date(targetYear, 0, 1); // Jan 1 of target year
                
                // Add extension if Force Majeure
                if (delayScenario === 'force_majeure') {
                    dcdDate.setMonth(dcdDate.getMonth() + codDelay);
                }

                // Calculate difference in months
                const diffTime = dcdDate.getTime() - coaDate.getTime();
                // If DCD is BEFORE COA, delay is 0.
                if (diffTime < 0) return 0;

                const diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30.44); // approx month
                
                return Math.max(0, Math.round(diffMonths));
            }, [targetYear, delayScenario, codDelay]);

            // Constraint Logic: Ensure Bid Price never exceeds GEAR Price
            const handleBidPriceChange = (val) => {
                if (val > CONSTANTS.PRELIMINARY_GEAR_PRICE) {
                    setBidPrice(CONSTANTS.PRELIMINARY_GEAR_PRICE);
                } else {
                    setBidPrice(val);
                }
            };

            // --- Business Logic (Updated to use dynamic baseFx) ---
            const calculateForexTariff = (bid, currentFx) => {
                if (currentFx < baseFx) {
                    return { tariff: bid, isFloor: true };
                }
                const adjusted = bid * (CONSTANTS.LOCAL_COMPONENT + (CONSTANTS.FOREX_COMPONENT * (currentFx / baseFx)));
                return { tariff: adjusted, isFloor: false };
            };

            const calculateInflationTariff = (bid, inflation, months) => {
                const factor = (inflation / 100) * months / 12;
                return bid * (1 + factor);
            };

            // --- Derived State ---
            const forexResult = calculateForexTariff(bidPrice, fxRate);
            const inflationTariffVal = calculateInflationTariff(bidPrice, inflationRate, calculatedMonthsDelay);
            
            const currentFinalTariff = activeTab === 'forex' ? forexResult.tariff : inflationTariffVal;
            const percentChange = ((currentFinalTariff - bidPrice) / bidPrice) * 100;
            const isFloorActive = activeTab === 'forex' && forexResult.isFloor;

            // --- Chart Data ---
            const currentChartData = useMemo(() => {
                const data = [];
                if (activeTab === 'forex') {
                    for (let rate = 50; rate <= 70; rate += 1) {
                        const res = calculateForexTariff(bidPrice, rate);
                        data.push({
                            xVal: rate,
                            tariff: parseFloat(res.tariff.toFixed(4)),
                            base: bidPrice,
                            isFloor: res.isFloor
                        });
                    }
                } else {
                    for (let m = 0; m <= 60; m += 2) {
                        const t = calculateInflationTariff(bidPrice, inflationRate, m);
                        data.push({
                            xVal: m,
                            tariff: parseFloat(t.toFixed(4)),
                            base: bidPrice
                        });
                    }
                }
                return data;
            }, [activeTab, bidPrice, inflationRate, fxRate, baseFx]); 

            const xLabel = activeTab === 'forex' ? "Exchange Rate (PHP/USD)" : "Duration (Months)";

            // Recharts check for Main Chart
            const Recharts = window.Recharts;
            const canRenderMainChart = Recharts && Recharts.AreaChart && Recharts.Area && Recharts.XAxis && Recharts.YAxis && Recharts.CartesianGrid && Recharts.Tooltip && Recharts.ResponsiveContainer && Recharts.ReferenceLine;

            const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } = Recharts || {};

            // Helper to safe render label
            const renderReferenceLabel = (props) => {
                const { viewBox, value, fill = "#666" } = props;
                return (
                    <text x={viewBox.x} y={viewBox.y} fill={fill} dy={-10} fontSize={10} textAnchor="middle">
                        {value}
                    </text>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto space-y-6">
                        
                        {/* Header */}
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-slate-900 flex items-center gap-2">
                                    <Icons.TrendingUp className="text-emerald-600" />
                                    GEAR5 Indexation Simulator
                                </h1>
                                <p className="text-slate-500 mt-1">
                                    Simulate Green Energy Auction Reserve Price adjustments.
                                </p>
                            </div>
                            <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-slate-200 shadow-sm text-sm">
                                <span className="text-slate-400">Preliminary GEAR Price:</span>
                                <span className="font-bold text-slate-800">PhP {CONSTANTS.PRELIMINARY_GEAR_PRICE} / kWh</span>
                            </div>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onClick={() => setActiveTab('forex')} className={`p-4 rounded-xl border-2 transition-all text-left ${activeTab === 'forex' ? 'border-blue-600 bg-blue-50 text-blue-700 ring-2 ring-blue-100' : 'border-white bg-white text-slate-600 hover:bg-slate-50'}`}>
                                <div className="font-bold flex items-center gap-2"><Icons.RefreshCcw size={18}/> Option 1: Forex</div>
                                <div className="text-xs opacity-75 mt-1">Adjusts for USD/PHP Fluctuations</div>
                            </button>
                            <button onClick={() => setActiveTab('inflation')} className={`p-4 rounded-xl border-2 transition-all text-left ${activeTab === 'inflation' ? 'border-purple-600 bg-purple-50 text-purple-700 ring-2 ring-purple-100' : 'border-white bg-white text-slate-600 hover:bg-slate-50'}`}>
                                <div className="font-bold flex items-center gap-2"><Icons.TrendingUp size={18}/> Option 2: Inflation</div>
                                <div className="text-xs opacity-75 mt-1">Adjusts for CPI over Time</div>
                            </button>
                            <button onClick={() => setActiveTab('comparison')} className={`p-4 rounded-xl border-2 transition-all text-left ${activeTab === 'comparison' ? 'border-emerald-600 bg-emerald-50 text-emerald-700 ring-2 ring-emerald-100' : 'border-white bg-white text-slate-600 hover:bg-slate-50'}`}>
                                <div className="font-bold flex items-center gap-2"><Icons.Scale size={18}/> Compare Mechanisms</div>
                                <div className="text-xs opacity-75 mt-1">Forex vs Inflation Scenario</div>
                            </button>
                        </div>

                        {/* Main Content Area */}
                        {activeTab === 'comparison' ? (
                            <ComparisonPanel 
                                bidPrice={bidPrice}
                                calculateForex={calculateForexTariff}
                                calculateInflation={calculateInflationTariff}
                                delayMonths={calculatedMonthsDelay}
                                baseFx={baseFx}
                            />
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                {/* Left Panel: Configuration */}
                                <div className="lg:col-span-4 space-y-6">
                                    <Card className="p-6 space-y-6">
                                        <h3 className="font-bold text-slate-900 flex items-center gap-2"><Icons.Settings size={18} /> Inputs</h3>
                                        
                                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="block text-xs font-bold text-slate-500 uppercase">Base Bid Price</label>
                                                <span className="text-[10px] text-emerald-600 font-medium">Max: {CONSTANTS.PRELIMINARY_GEAR_PRICE}</span>
                                            </div>
                                            <div className="flex items-center">
                                                <span className="text-slate-400 font-bold mr-2">₱</span>
                                                <input 
                                                    type="number" 
                                                    value={bidPrice} 
                                                    max={CONSTANTS.PRELIMINARY_GEAR_PRICE}
                                                    step="0.0001" 
                                                    onChange={(e) => handleBidPriceChange(parseFloat(e.target.value))} 
                                                    className="w-full bg-transparent font-mono text-lg font-bold outline-none"
                                                />
                                            </div>
                                        </div>

                                        {/* New Base FX Rate Input Cell */}
                                        {activeTab === 'forex' && (
                                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase">Base FX Rate</label>
                                                    <span className="text-[10px] text-blue-600 font-medium">Default: {CONSTANTS.DEFAULT_BASE_FX.toFixed(2)}</span>
                                                </div>
                                                <div className="flex items-center">
                                                    <span className="text-slate-400 font-bold mr-2">₱</span>
                                                    <input 
                                                        type="number" 
                                                        value={baseFx} 
                                                        min={1}
                                                        max={100}
                                                        step="0.01" 
                                                        onChange={(e) => setBaseFx(parseFloat(e.target.value))} 
                                                        className="w-full bg-transparent font-mono text-lg font-bold outline-none text-blue-700"
                                                    />
                                                </div>
                                            </div>
                                        )}

                                        {activeTab === 'forex' ? (
                                            <>
                                                <SliderControl label="FX Rate (PHP/USD)" value={fxRate} min={50} max={70} step={0.1} unit="₱" onChange={setFxRate} note={`Comparing against Base Rate: ${baseFx.toFixed(4)}`}/>
                                                <div className={`p-3 rounded border text-xs flex gap-2 mb-6 ${isFloorActive ? 'bg-emerald-50 text-emerald-800 border-emerald-200' : 'bg-slate-50 text-slate-500'}`}>
                                                    <Icons.AlertCircle size={16} className="shrink-0 mt-0.5" />
                                                    <p>{isFloorActive ? "Floor Price Active: Rate held at Bid Price." : "Tariff adjusting for depreciation."}</p>
                                                </div>
                                                
                                                {/* SHARED TIMELINE CONTROL (FOREX) */}
                                                <TimelineControl 
                                                    year={targetYear} setYear={setTargetYear}
                                                    scenario={delayScenario} setScenario={setDelayScenario}
                                                    codDelay={codDelay} setCodDelay={setCodDelay}
                                                    computedDelay={calculatedMonthsDelay}
                                                />
                                            </>
                                        ) : (
                                            <>
                                                {/* INFLATION SPECIFIC CONTROLS */}
                                                <SliderControl label="Inflation Rate" value={inflationRate} min={0} max={10} step={0.1} unit="%" onChange={setInflationRate}/>
                                                
                                                {/* SHARED TIMELINE CONTROL (INFLATION) */}
                                                <TimelineControl 
                                                    year={targetYear} setYear={setTargetYear}
                                                    scenario={delayScenario} setScenario={setDelayScenario}
                                                    codDelay={codDelay} setCodDelay={setCodDelay}
                                                    computedDelay={calculatedMonthsDelay}
                                                />
                                            </>
                                        )}
                                    </Card>
                                </div>

                                {/* Right Panel: Visualization */}
                                <div className="lg:col-span-8 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <MetricBox label="Adjusted Tariff" value={`₱ ${currentFinalTariff.toFixed(4)}`} subtext="/ kWh" icon={Icons.DollarSign} trend="neutral" />
                                        <MetricBox label="Change" value={`${percentChange > 0 ? '+' : ''}${percentChange.toFixed(2)}%`} subtext="Percentage" icon={Icons.TrendingUp} trend={percentChange > 0 ? 'up' : 'neutral'} />
                                        <MetricBox label="Impact" value={`₱ ${(currentFinalTariff - bidPrice).toFixed(4)}`} subtext="Absolute" icon={Icons.Calculator} trend={percentChange > 0 ? 'up' : 'neutral'} />
                                    </div>

                                    <Card className="p-6 h-[400px]">
                                        {/* Main Chart Guard */}
                                        {canRenderMainChart ? (
                                            <ResponsiveContainer width="100%" height="100%">
                                                <AreaChart data={currentChartData} margin={{ top: 10, right: 30, left: 0, bottom: 30 }}>
                                                    <defs>
                                                        <linearGradient id="colorTariff" x1="0" y1="0" x2="0" y2="1">
                                                            <stop offset="5%" stopColor={activeTab === 'forex' ? "#2563eb" : "#9333ea"} stopOpacity={0.1}/>
                                                            <stop offset="95%" stopColor={activeTab === 'forex' ? "#2563eb" : "#9333ea"} stopOpacity={0}/>
                                                        </linearGradient>
                                                    </defs>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                    <XAxis dataKey="xVal" label={{ value: xLabel, position: 'insideBottom', offset: -5, style: { fill: '#64748b', fontSize: '12px' } }} tick={{ fill: '#64748b', fontSize: '12px' }} />
                                                    <YAxis domain={['auto', 'auto']} tickFormatter={(val) => `₱${val.toFixed(2)}`} tick={{ fill: '#64748b', fontSize: '12px' }} />
                                                    <Tooltip contentStyle={{ borderRadius: '8px', border: '1px solid #e2e8f0' }} formatter={(value) => [`₱ ${value.toFixed(4)}`, 'Tariff']} />
                                                    <Area type="monotone" dataKey="tariff" stroke={activeTab === 'forex' ? "#2563eb" : "#9333ea"} strokeWidth={3} fillOpacity={1} fill="url(#colorTariff)" />
                                                    <ReferenceLine y={bidPrice} stroke="#94a3b8" strokeDasharray="3 3" label={(props) => renderReferenceLabel({...props, value: 'Base'})} />
                                                    <ReferenceLine x={activeTab === 'forex' ? fxRate : calculatedMonthsDelay} stroke="#ef4444" strokeDasharray="3 3" label={(props) => renderReferenceLabel({...props, value: 'Current', fill: '#ef4444'})} />
                                                </AreaChart>
                                            </ResponsiveContainer>
                                        ) : <div className="h-full flex items-center justify-center text-slate-400">Loading Chart Components...</div>}
                                    </Card>
                                </div>
                            </div>
                        )}

                        {/* Heat Maps Section */}
                        {activeTab === 'forex' && (
                            <ForexHeatMap calculateTariff={calculateForexTariff} baseFx={baseFx} />
                        )}
                        {activeTab === 'inflation' && (
                            <InflationHeatMap calculateTariff={calculateInflationTariff} inflationRate={inflationRate} />
                        )}

                        {/* References Section */}
                        <ReferenceSection baseFx={baseFx} />

                        <div className="text-center text-xs text-slate-400 pt-8 pb-4">
                            <p>Based on "Proposed Preliminary Green Energy Auction Reserve Price for Round 5 (GEAR5)" Document.</p>
                            <p>Parameters: Base FX {baseFx.toFixed(2)} | 30% Local / 70% Forex Split.</p>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IndexationSimulator />);
    </script>
</body>
</html>
